<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SignalR + Angular для .NET Core</title>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,600">
    <link href="/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/native.css">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Radiofisik" href="/feed.xml" />
</head>


<body class="preload">
    <div class="top"></div>
    <div class="profile" style="background-image: url(/resources/img/background.jpg);">
        <a href="/"><img src="//www.gravatar.com/avatar/ddf1a8cb93900b0cb7b86d96663a54d4?s=100" class="img-avatar" /></a>
        <h3> Radiofisik</h3>
        <p>my knowledge base</p>
        <ul class="social">
            
            <a type="button" href="//github.com/radiofisik">
                <i class="fa fa-github"></i>
            </a>
             
            <a type="button" href="//twitter.com/radiofisik39">
                <i class="fa fa-twitter"></i>
            </a>
              
            <a type="button" href="//pinterest.com/0liks8jl05hcpyb1chvg0b9teugvwf">
                <i class="fa fa-pinterest"></i>
            </a>
              
            <a type="button" href="//vk.com/id3171419">
                <i class="fa fa-vk"></i>
            </a>
            
        </ul>
    </div>
    <div class="posts">
        <div class="content post">
  <h1 class="post-title">SignalR + Angular для .NET Core</h1>
  <div class="post-date">
    <time>02 May 2019</time>
  </div>
  <p>Создадим новый проект Visual Studio через команду <code class="highlighter-rouge">dotnet new</code> набрав ее без параметров получим список возможных шаблонов. Будем использовать самый простой.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet new web
</code></pre></div></div>

<h2 id="signalr">SignalR</h2>

<p>Установим nuget пакеты</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet add package Microsoft.AspNetCore.SignalR
</code></pre></div></div>

<p>В Startup.cs зарегистрируем сервис</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">services</span><span class="p">.</span><span class="nf">AddSignalR</span><span class="p">();</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>Создадим класс хаба</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">MessageHub</span><span class="p">:</span> <span class="n">Hub</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">Task</span> <span class="nf">Send</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">Clients</span><span class="p">.</span><span class="n">All</span><span class="p">.</span><span class="nf">SendAsync</span><span class="p">(</span><span class="s">"Send"</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Зарегистрируем SignalR middleware</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">,</span> <span class="n">IHostingEnvironment</span> <span class="n">env</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">app</span><span class="p">.</span><span class="nf">UseSignalR</span><span class="p">(</span><span class="n">routes</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="n">routes</span><span class="p">.</span><span class="n">MapHub</span><span class="p">&lt;</span><span class="n">MessageHub</span><span class="p">&gt;(</span><span class="s">"/message"</span><span class="p">);</span> <span class="p">});</span>
        <span class="p">}</span>
</code></pre></div></div>

<h2 id="mvc">MVC</h2>

<p>Для целей тестирования добавим контроллер с методом который будет принимать сообщения и слать через SignalR. Для этого зарегистрируем mvc и добавим класс контроллера</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">services</span><span class="p">.</span><span class="nf">AddMvc</span><span class="p">();</span> <span class="c1">// в ConfigureServices</span>

<span class="n">app</span><span class="p">.</span><span class="nf">UseMvc</span><span class="p">();</span> <span class="c1">// в Configure</span>

<span class="c1">// контроллер</span>
 <span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"api/message"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MessageController</span><span class="p">:</span> <span class="n">Controller</span>
    <span class="p">{</span>
     	<span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Post</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>изменим контроллер чтобы он мог отправлять сообщения клиенту</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">[Route("api/message")]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MessageController</span><span class="p">:</span> <span class="n">Controller</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IHubContext</span><span class="p">&lt;</span><span class="n">MessageHub</span><span class="p">&gt;</span> <span class="n">_hubContext</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">MessageController</span><span class="p">(</span><span class="n">IHubContext</span><span class="p">&lt;</span><span class="n">MessageHub</span><span class="p">&gt;</span> <span class="n">hubContext</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_hubContext</span> <span class="p">=</span> <span class="n">hubContext</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span>
        <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Post</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_hubContext</span><span class="p">.</span><span class="n">Clients</span><span class="p">.</span><span class="n">All</span><span class="p">.</span><span class="nf">SendCoreAsync</span><span class="p">(</span><span class="s">"send"</span><span class="p">,</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span><span class="s">"hello from server"</span><span class="p">});</span>
            <span class="k">return</span> <span class="nf">Ok</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<h2 id="swashbuckle">Swashbuckle</h2>

<p>Для удобства запуска метода контроллера добавим swagger через Swashbuckle</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet add package Swashbuckle.AspNetCore
</code></pre></div></div>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">services</span><span class="p">.</span><span class="nf">AddSwaggerGen</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">c</span><span class="p">.</span><span class="nf">SwaggerDoc</span><span class="p">(</span><span class="s">"v1"</span><span class="p">,</span> <span class="k">new</span> <span class="n">Info</span> <span class="p">{</span> <span class="n">Title</span> <span class="p">=</span> <span class="s">"My API"</span><span class="p">,</span> <span class="n">Version</span> <span class="p">=</span> <span class="s">"v1"</span> <span class="p">});</span>
    <span class="p">});</span>
</code></pre></div></div>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">// Enable middleware to serve generated Swagger as a JSON endpoint.</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">UseSwagger</span><span class="p">();</span>

    <span class="c1">// Enable middleware to serve swagger-ui (HTML, JS, CSS, etc.), </span>
    <span class="c1">// specifying the Swagger JSON endpoint.</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">UseSwaggerUI</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">c</span><span class="p">.</span><span class="nf">SwaggerEndpoint</span><span class="p">(</span><span class="s">"/swagger/v1/swagger.json"</span><span class="p">,</span> <span class="s">"My API V1"</span><span class="p">);</span>
    <span class="p">});</span>
</code></pre></div></div>

<p>После чего будут доступны ` http://localhost:<port>/swagger` &lt;https://localhost:44369/swagger/index.html&gt; в конкретном случае и `http://localhost:<port>/swagger/v1/swagger.json`. Подробней про swashbuckle &lt;https://docs.microsoft.com/ru-ru/aspnet/core/tutorials/getting-started-with-swashbuckle?view=aspnetcore-2.2&amp;tabs=netcore-cli&gt;</port></port></p>

<p><img src="swagger.png" alt="swagger" /></p>

<h2 id="angular">Angular</h2>

<p>Создадим проект с помощью Angular CLI</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ng new signalrclient
cd .\signalrclient\
npm install
npm install @aspnet/signalr --save
</code></pre></div></div>

<p>подредактируем app.component.ts чтобы логировать в консоль получаемые сообщения</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">signalR</span> <span class="k">from</span> <span class="s1">'@aspnet/signalr'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-root'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./app.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./app.component.scss'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>
  <span class="nx">title</span> <span class="o">=</span> <span class="s1">'signalrclient'</span><span class="p">;</span>
  <span class="nx">ngOnInit</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">signalR</span><span class="p">.</span><span class="nx">HubConnectionBuilder</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">withUrl</span><span class="p">(</span><span class="s1">'https://localhost:44369/message'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">build</span><span class="p">();</span>

    <span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">connection</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">invoke</span><span class="p">(</span><span class="s1">'send'</span><span class="p">,</span> <span class="s1">'hi'</span><span class="p">))</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Error while starting connection: '</span> <span class="o">+</span> <span class="nx">err</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Запустим проект через <code class="highlighter-rouge">ng serve</code> После запуска откроем <a href="http://localhost:4200/">http://localhost:4200/</a>  в консоле увидим ошибку типичную для CORS. Возникает она потому что по умолчанию кроссдоменный запрос запрещен.</p>

<p><img src="error.png" alt="error" /></p>

<h2 id="cors">CORS</h2>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">services</span><span class="p">.</span><span class="nf">AddCors</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">options</span><span class="p">.</span><span class="nf">AddPolicy</span><span class="p">(</span><span class="s">"CorsPolicy"</span><span class="p">,</span>
            <span class="n">builder</span> <span class="p">=&gt;</span> <span class="n">builder</span><span class="p">.</span><span class="nf">WithOrigins</span><span class="p">(</span><span class="s">"http://localhost:4200"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">AllowAnyMethod</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">AllowAnyHeader</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">AllowCredentials</span><span class="p">());</span>
    <span class="p">});</span>
</code></pre></div></div>

<p>добавим midleware которое добавить заголовки cors</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">app</span><span class="p">.</span><span class="nf">UseCors</span><span class="p">(</span><span class="s">"CorsPolhttps://www.youtube.com/watch?v=R3UJjSAH6bMicy"</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="resultconsole.png" alt="resultconsole" /></p>

<blockquote>
  <p>Получившийся проект можно загрузить по ссылке https://github.com/Radiofisik/SignalRAngular.git</p>
</blockquote>

<p>При написании использованы материалы:</p>

<ul>
  <li><a href="https://www.youtube.com/watch?v=R3UJjSAH6bM">https://www.youtube.com/watch?v=R3UJjSAH6bM</a></li>
  <li><a href="https://code-maze.com/netcore-signalr-angular/">https://code-maze.com/netcore-signalr-angular/</a></li>
  <li><a href="https://habr.com/ru/post/338490/">https://habr.com/ru/post/338490/</a></li>
</ul>


</div>

  
<div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = 'radiofisik-ru';
var disqus_identifier = '/2019/05/02/signalr-angular/';

(function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






    </div>
</body>
<script type="text/javascript">
    window.onload = function(){
        document.getElementsByTagName("BODY")[0].classList.remove("preload");
    }
</script>
</html>
